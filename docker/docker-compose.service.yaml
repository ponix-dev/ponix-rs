name: ponix-service

include:
  - docker-compose.deps.yaml

services:
  ponix-all-in-one:
    image: ponix-all-in-one:latest
    container_name: ponix-all-in-one
    ports:
      - "50051:50051" # gRPC server
    environment:
      # Service configuration
      PONIX_LOG_LEVEL: info
      PONIX_MESSAGE: "Hello from ponix-rs!"
      PONIX_INTERVAL_SECS: "3"
      PONIX_STARTUP_TIMEOUT_SECS: "30"

      # NATS configuration
      PONIX_NATS_URL: "nats://ponix-nats:4222"
      PONIX_PROCESSED_ENVELOPES_STREAM: "processed_envelopes"
      PONIX_PROCESSED_ENVELOPES_SUBJECT: "processed_envelopes.>"
      PONIX_NATS_RAW_STREAM: "raw_envelopes"
      PONIX_NATS_RAW_SUBJECT: "raw_envelopes.>"
      PONIX_NATS_GATEWAY_STREAM: "gateways"
      PONIX_NATS_GATEWAY_SUBJECT: "gateways.>"
      PONIX_NATS_BATCH_SIZE: "30"
      PONIX_NATS_BATCH_WAIT_SECS: "5"

      # ClickHouse configuration
      PONIX_CLICKHOUSE_URL: "http://ponix-clickhouse:8123"
      PONIX_CLICKHOUSE_NATIVE_URL: "ponix-clickhouse:9000"
      PONIX_CLICKHOUSE_DATABASE: "ponix"
      PONIX_CLICKHOUSE_USERNAME: "ponix"
      PONIX_CLICKHOUSE_PASSWORD: "ponix"
      PONIX_CLICKHOUSE_MIGRATIONS_DIR: "/home/ponix/migrations/clickhouse"
      PONIX_CLICKHOUSE_GOOSE_BINARY_PATH: "/usr/local/bin/goose"

      # PostgreSQL configuration
      PONIX_POSTGRES_HOST: "ponix-postgres"
      PONIX_POSTGRES_PORT: "5432"
      PONIX_POSTGRES_DATABASE: "ponix"
      PONIX_POSTGRES_USERNAME: "ponix"
      PONIX_POSTGRES_PASSWORD: "ponix"
      PONIX_POSTGRES_MIGRATIONS_DIR: "/home/ponix/migrations/postgres"
      PONIX_POSTGRES_GOOSE_BINARY_PATH: "/usr/local/bin/goose"

      # gRPC configuration
      PONIX_GRPC_HOST: "0.0.0.0"
      PONIX_GRPC_PORT: "50051"

      # JWT configuration
      PONIX_JWT_SECRET: "change-me-in-production-use-a-secure-random-string"
      PONIX_JWT_EXPIRATION_HOURS: "24"

      # Refresh token configuration
      PONIX_REFRESH_TOKEN_EXPIRATION_DAYS: "7"
      PONIX_SECURE_COOKIES: "false"  # Set to true in production with HTTPS

      # gRPC Telemetry configuration
      PONIX_GRPC_IGNORED_PATHS: "/grpc.reflection."

      # OpenTelemetry configuration
      PONIX_OTEL_ENABLED: "true"
      PONIX_OTEL_SERVICE_NAME: "ponix-all-in-one"
      PONIX_OTEL_ENDPOINT: "http://otel-lgtm:4317"

      # CDC configuration
      PONIX_CDC_GATEWAY_ENTITY_NAME: "gateways"
      PONIX_CDC_GATEWAY_TABLE_NAME: "gateways"
      PONIX_CDC_PUBLICATION_NAME: "ponix_cdc_publication"
      PONIX_CDC_SLOT_NAME: "ponix_cdc_slot"
      PONIX_CDC_BATCH_SIZE: "100"
      PONIX_CDC_BATCH_TIMEOUT_MS: "5000"
      PONIX_CDC_RETRY_DELAY_MS: "10000"
      PONIX_CDC_MAX_RETRY_ATTEMPTS: "5"
    depends_on:
      - nats
      - clickhouse
      - postgres
      - otel-lgtm
    restart: unless-stopped
    networks:
      - ponix
